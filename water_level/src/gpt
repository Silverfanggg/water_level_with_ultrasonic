#include <Arduino.h>

// Pin Definitions
const int trigPin = 5;
const int echoPin = 18;

// Sensor Configuration
const float SENSOR_HEIGHT_MM = 200.0; // Sensörün yüksekliği

void setup()
{
  Serial.begin(115200);
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
}

// Ultrasonik sensörden mesafe ölçümü (mm cinsinden)
float measureDistance()
{
  // Trigger pulse gönder
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  // Echo pulse süresini ölç (timeout: 25ms)
  long duration = pulseIn(echoPin, HIGH, 25000);
  
  // Eğer timeout olursa geçersiz ölçüm
  if (duration == 0)
    return -1.0;

  // Mesafeyi mm cinsinden hesapla (ses hızı: 343 m/s)
  // distance = (duration / 2) * 0.343 mm/us
  float distance_mm = (duration / 2.0) * 0.343;
  
  return distance_mm;
}

// 5 ölçümün ortalamasını al
float getAverageDistance()
{
  float total = 0;
  int validCount = 0;

  for (int i = 0; i < 5; i++)
  {
    float d = measureDistance();
    if (d > 0)
    {
      total += d;
      validCount++;
    }
    delay(100); // Ölçümler arasında 100ms bekle
  }

  if (validCount == 0)
    return -1.0;

  return total / validCount;
}

// Su seviyesini yüzde olarak hesapla
int calculateWaterLevel(float distance_mm)
{
  if (distance_mm < 0)
    return -1;

  // Sensörden su yüzeyine olan mesafe
  float waterHeight = SENSOR_HEIGHT_MM - distance_mm;

  // Eğer su seviyesi negatif ise (sensörün altında) -> %0
  if (waterHeight <= 0)
    return 0;

  // Bardak boşken su yüksekliği 0, doluyken maksimum
  // Burada su seviyesini yüzde olarak göster
  // Örnek: bardak 98mm ise maksimum yükseklik 98mm
  // Su yüksekliği / maksimum yükseklik * 100
  
  // Şimdilik sensörün 200mm'den ölçülen mesafeyi direkt göster
  int waterPercent = (int)(waterHeight);
  
  if (waterPercent < 0) waterPercent = 0;
  if (waterPercent > 100) waterPercent = 100;

  return waterPercent;
}

void loop()
{
  // 5 ölçümün ortalamasını al
  float avgDistance = getAverageDistance();

  if (avgDistance < 0)
  {
    Serial.println("Ölçüm başarısız!");
  }
  else
  {
    // Su yüksekliğini hesapla
    float waterHeight = SENSOR_HEIGHT_MM - avgDistance;
    int waterPercent = calculateWaterLevel(avgDistance);

    // Serial monitöre yazdır
    Serial.print("Sensör Mesafesi: ");
    Serial.print(avgDistance);
    Serial.print(" mm | Su Yüksekliği: ");
    Serial.print(waterHeight);
    Serial.print(" mm | Yüzde: ");
    Serial.print(waterPercent);
    Serial.println(" %");
  }

  // Her 2 saniyede bir ölçüm al
  delay(2000);
}